<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000" media="(prefers-color-scheme: dark)">
    <title>Albumart.Digital</title>
    <link rel="stylesheet" href="/style.css" />
    <script>
        let result = null
        let empty = false
        let spinner_showing = false

        // We cancel the fetch each time they continue typing.
        let cancel_signal = new AbortController()

        document.addEventListener("DOMContentLoaded", function() {
            result = document.getElementById('search-result')
        })

        async function input_oninput(str) {
            str = str.trim()
            if (str === '') {
                empty = true
                spinner_showing = false
                cancel_signal.abort()
                result.innerHTML = ''
                return
            }

            tmp = await api_get(str)
            if (tmp != '') {
                result.innerHTML = tmp
            }
        }

        function input_onkeydown() {
            // clearTimeout(timer)
        }

        async function api_get(query) {
            if (empty) {
                if (!spinner_showing) {
                    spinner_showing = true
                    return '<div class="lds-spinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>'
                }
            } else {
                cancel_signal.abort()
            }

            cancel_signal = new AbortController()
            let resp = ''
            let body = ''
            try {
                resp = await fetch('https://albumart.digital/api?' +
                    new URLSearchParams({
                        q: query,
                    }), {
                        method: 'get',
                        signal: cancel_signal.signal,
                    })
                body = await resp.text()
            } catch (_) {
                return ''
            }
            spinner_showing = false
            empty = false
            return body
        }
    </script>
</head>

<body>
    <header>
        <div>
            <h1>ALBUMART.DIGITAL</h1>
            <p>Made by Ayman El Didi.</p>
        </div>
        <input type="text" id="search-box" class="box" placeholder="Search for an album..." aria-placeholder="Search for an album..." aria-label="Search for an album..." oninput="input_oninput(this.value)" onkeydown="input_onkeydown()" />
    </header>
    <main>
        <div id="search-result">
        </div>
        <div class="background"></div>
    </main>
    <footer>
    </footer>
</body>

</html>